# Migration CalendarService - karibou-seed

## üéØ Objectif

Centraliser la gestion des dates via `CalendarService` de `@kng2-core` pour assurer la coh√©rence timezone entre le backend (UTC) et le frontend (HUB-CENTRIC Europe/Zurich).

## üìã Principe Fondamental

### Stockage Backend (UTC)
```typescript
// ‚úÖ order.shipping.when est TOUJOURS en UTC (stock√© en DB)
order.shipping.when = new Date('2024-12-30T15:00:00.000Z');
```

### Client Frontend (HUB-CENTRIC)
```typescript
// ‚úÖ Le client travaille en timezone Hub (Europe/Zurich)
// CalendarService centralise TOUTES les cr√©ations et comparaisons de dates
import { CalendarService } from '@kng2-core';

// Injection Angular
constructor(private $calendar: CalendarService) {}

// Usage
const hubDate = this.$calendar.toHubTime(order.shipping.when, hub);
const displayDate = this.$calendar.formatForClient(order.shipping.when, hub);
```

## üîß API CalendarService - 2 Fonctions Principales

### 1. `getValidShippingDatesForHub()` - Dates de Livraison
```typescript
// ‚úÖ FONCTION PRINCIPALE : Retourne les dates disponibles
const availableDates = this.$calendar.getValidShippingDatesForHub(hub, {
  days: 7,                    // Nombre de jours √† chercher
  user: this.user,            // Pour limites premium
  currentRanks: config.shared.currentRanks,
  detailed: false             // true pour format enrichi
});

// ‚úÖ Premier jour disponible
const nextDay = availableDates[0];
```

### 2. `timeleftBeforeCollect()` - Temps Restant
```typescript
// ‚úÖ FONCTION PRINCIPALE : Calcule le temps restant avant deadline
const hoursLeft = this.$calendar.timeleftBeforeCollect(
  hub,
  product.attributes.timelimit,  // Dur√©e pr√©paration produit (optionnel)
  shippingDate                    // Date de livraison choisie
);

// ‚úÖ Avec interface compl√®te pour UI
const timing = this.$calendar.timeleftBeforeCollect(
  hub, productLimit, when,
  { includeInterface: true }
) as ProductOrderTiming;
// ‚Üí { isOutOfTimeLimit, shouldShowCountdown, hoursLeft, formattedTimeLeft, formattedDeadline }
```

## üîÑ Fonctions D√©pr√©ci√©es ‚Üí Migration

| ‚ùå Ancien (D√©pr√©ci√©) | ‚úÖ Nouveau |
|---------------------|-----------|
| `Order.nextShippingDay()` | `$calendar.getValidShippingDatesForHub()[0]` |
| `Order.fullWeekShippingDays()` | `$calendar.getValidShippingDatesForHub()` |
| `config.potentialShippingDay()` | `$calendar.potentialShippingDay()` |
| `config.getDefaultTimeByDay()` | `$calendar.getDefaultTimeByDay()` |
| `config.timeleftBeforeCollect()` | `$calendar.timeleftBeforeCollect()` |

## üìÅ Composants √† Migrer

### Priorit√© Haute (Bugs Critiques)
- [ ] `product.component.ts` - Countdown timezone
- [ ] `kng-calendar.component.ts` - S√©lection dates
- [ ] `kng-home.component.ts` - Date principale

### Priorit√© Moyenne
- [ ] `kng-navbar.component.ts` - Status ouvert/ferm√©
- [ ] `kng-cart-items.component.ts` - Validation panier
- [ ] `kng-cart.component.ts` - √âtat panier
- [ ] `kng-cart-checkout.component.ts` - Processus commande

### Pattern de Migration
```typescript
// 1. Ajouter injection
constructor(
  private $cart: CartService,
  private config: Config,
  private $calendar: CalendarService // ‚úÖ NOUVEAU
) {}

// 2. Remplacer les appels
// ‚ùå AVANT
const nextDay = Order.nextShippingDay(this.user, this.hub);
const timeLeft = this.config.timeleftBeforeCollect(hub, limit, when);

// ‚úÖ APR√àS
const nextDay = this.$calendar.getValidShippingDatesForHub(this.hub)[0];
const timeLeft = this.$calendar.timeleftBeforeCollect(hub, limit, when);
```

## ‚úÖ R√®gles de Coh√©rence

### Comparaison de Dates
```typescript
// ‚ùå AVANT (sensible timezone)
if (date1.getTime() === date2.getTime()) { ... }

// ‚úÖ APR√àS (compare le jour uniquement)
if (date1.equalsDate(date2)) { ... }
// ou
if (date1.toYYYYMMDD('-') === date2.toYYYYMMDD('-')) { ... }
```

### Affichage Localis√©
```typescript
// ‚úÖ Toujours utiliser formatForClient pour l'affichage
const displayDate = this.$calendar.formatForClient(utcDate, hub);
// ‚Üí "lundi 30 d√©cembre 2024" (timezone Swiss)
```

### Internationalisation
```typescript
// ‚úÖ Noms de jours/mois localis√©s
const weekdays = this.$calendar.i18n_weekdays('fr'); // ['dimanche', 'lundi', ...]
const months = this.$calendar.i18n_months('fr');     // ['janvier', 'f√©vrier', ...]
const shortDay = this.$calendar.getWeekDay(1, 'fr'); // 'lun.'
```

## üîó Interface ProductOrderTiming

```typescript
export interface ProductOrderTiming {
  isOutOfTimeLimit: boolean;      // Trop tard pour commander
  shouldShowCountdown: boolean;   // Afficher le countdown
  hoursLeft: number;              // Heures restantes (peut √™tre n√©gatif)
  formattedTimeLeft: string;      // "2 h 30 minutes"
  formattedDeadline: string;      // "14h30"
}
```

## üìä Logique M√©tier

### Configuration Hub
```typescript
hub = {
  timelimit: 12,           // ‚úÖ 12h de pr√©paration par d√©faut
  timelimitH: 10,          // ‚úÖ Collecte √† 10h Swiss
  weekdays: [1,2,3,4,5,6], // Jours de livraison
  timezone: 'Europe/Zurich'
}
```

### Calcul Deadline
```
Deadline Client = Heure Collecte (timelimitH) - Temps Pr√©paration (timelimit)

Exemple pour livraison MARDI :
- Collecte = MARDI 10h00 Swiss
- Pr√©paration = 12h
- Deadline = MARDI 10h - 12h = LUNDI 22h00
‚Üí Commander AVANT lundi 22h pour livraison mardi
```

## üö® Fonctions √† Centraliser dans CalendarService

### Fonctions Existantes (√† utiliser)
```typescript
// ‚úÖ UTILISER ces fonctions au lieu de manipuler les dates directement
$calendar.toHubTime(utcDate, hub)           // UTC ‚Üí Hub timezone
$calendar.toUTC(hubDate, hub)               // Hub ‚Üí UTC
$calendar.formatForClient(utcDate, hub)     // Affichage localis√©
$calendar.getValidShippingDatesForHub()     // Dates disponibles
$calendar.timeleftBeforeCollect()           // Temps restant
$calendar.isInAvailableDays(day, list)      // V√©rifier si jour dans liste
$calendar.isDayAvailable(day, list, opts)   // Validation compl√®te avec currentRanks
$calendar.getDefaultTimeByDay(day, hub)     // Heure par d√©faut (16h ou 12h samedi)
$calendar.i18n_weekdays(lang)               // Noms des jours localis√©s
$calendar.i18n_months(lang)                 // Noms des mois localis√©s
```

### Fonctions √† Ajouter (TODO)
```typescript
// üîß √Ä IMPL√âMENTER dans CalendarService pour √©viter manipulations externes

/**
 * Normalise une date au d√©but du jour (minuit) en timezone Hub
 * Remplace: date.setHours(0, 0, 0, 0)
 */
normalizeToStartOfDay(date: Date, hub?: Hub): Date

/**
 * Normalise une date √† midi en timezone Hub (safe pour parsing YYYY-MM-DD)
 * Remplace: date.setHours(12, 0, 0, 0) ou new Date(str + 'T12:00:00')
 */
normalizeToNoon(date: Date, hub?: Hub): Date

/**
 * Compare deux dates par jour uniquement (ignore l'heure)
 * Remplace: date1.toYYYYMMDD() === date2.toYYYYMMDD()
 */
isSameDay(date1: Date, date2: Date): boolean

/**
 * Cr√©e une date locale pour un jour du mois (calendrier)
 * Remplace: new Date(year, month, day) + setHours()
 */
createLocalDate(year: number, month: number, day: number, hub?: Hub): Date

/**
 * Parse une string YYYY-MM-DD en Date safe (midi Hub)
 * Remplace: new Date(str + 'T12:00:00')
 */
parseDateString(dateStr: string, hub?: Hub): Date

/**
 * Retourne la cl√© string pour Map (YYYY-MM-DD)
 * Remplace: date.toYYYYMMDD('-')
 */
toDateKey(date: Date): string

/**
 * Ajoute N jours √† une date
 * Remplace: date.plusDays(n) ou manipulation manuelle
 */
addDays(date: Date, days: number): Date
```

### Patterns Interdits ‚Üí Remplacement

| ‚ùå Pattern Interdit | ‚úÖ Utiliser CalendarService |
|--------------------|----------------------------|
| `date.setHours(0,0,0,0)` | `$calendar.normalizeToStartOfDay(date)` |
| `date.setUTCHours(0,0,0,0)` | ‚ùå NE PAS UTILISER c√¥t√© client |
| `date.setHours(12,0,0,0)` | `$calendar.normalizeToNoon(date)` |
| `new Date(str + 'T12:00:00')` | `$calendar.parseDateString(str)` |
| `date1.toYYYYMMDD() === date2.toYYYYMMDD()` | `$calendar.isSameDay(date1, date2)` |
| `date.equalsDate(other)` | `$calendar.isSameDay(date, other)` |
| `new Date(year, month, day)` | `$calendar.createLocalDate(year, month, day)` |
| `date.toYYYYMMDD('-')` | `$calendar.toDateKey(date)` |
| `date.plusDays(n)` | `$calendar.addDays(date, n)` |
| `Order.nextShippingDay()` | `$calendar.getValidShippingDatesForHub()[0]` |
| `config.timeleftBeforeCollect()` | `$calendar.timeleftBeforeCollect()` |

### Pourquoi Centraliser ?

1. **Coh√©rence Timezone** : CalendarService g√®re automatiquement Hub timezone
2. **Testabilit√©** : Logique test√©e une seule fois dans le service
3. **Maintenabilit√©** : Un seul endroit pour les corrections de bugs
4. **Documentation** : API claire avec types TypeScript
5. **√âviter les Erreurs** : Plus de m√©lange UTC/local dans les composants

## üõ°Ô∏è Strat√©gie Migration Zero Downtime

1. **Phase 0** : Injection CalendarService dans composants (sans utilisation)
2. **Phase 1** : Migration fonction par fonction avec try/catch fallback
3. **Phase 2** : Suppression des anciens appels
4. **Phase 3** : Nettoyage code d√©pr√©ci√©

Voir `karibou-seed/.cursor/rules/karibou-ch-frontend.mdc` section 7-8 pour le plan complet.
