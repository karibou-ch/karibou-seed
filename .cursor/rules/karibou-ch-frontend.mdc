---
description: "RÃ¨gles et conventions pour le projet frontend (@/karibou-seed)"
globs:
alwaysApply: true
---
# RÃ¨gles et Conventions du Projet Frontend (karibou-seed)

Ce document dÃ©crit les rÃ¨gles, conventions et bonnes pratiques Ã  suivre pour le dÃ©veloppement du projet frontend `karibou-seed`. L'objectif est d'assurer la cohÃ©rence, la maintenabilitÃ© et la qualitÃ© du code.
* VÃ©rifier la racine du projet `~/nodejs/karibou.ch/karibou-seed` avant un git ou la crÃ©ation de fichiers.

## 1. Objectif du Projet

`karibou-seed` est un projet "white-label" basÃ© sur Angular, conÃ§u pour servir de socle Ã  des plateformes de e-commerce, principalement pour des groupements d'artisans ou des hubs alimentaires. Il est pensÃ© pour Ãªtre personnalisable via un systÃ¨me de theming et de configuration.

## 2. Structure des Fichiers et Dossiers (`src/`)

La structure du projet suit les conventions d'Angular, avec une organisation orientÃ©e par fonctionnalitÃ©.

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ common/         # Composants, services, et directives rÃ©utilisables
â”‚   â”œâ”€â”€ kng-admin/      # Modules et composants pour la section admin
â”‚   â”œâ”€â”€ kng-cart/       # Logique et affichage du panier
â”‚   â”œâ”€â”€ kng-home/       # Page d'accueil
â”‚   â”œâ”€â”€ kng-user/       # Espace utilisateur (profil, commandes, etc.)
â”‚   â”œâ”€â”€ ...             # Autres dossiers de fonctionnalitÃ©s (kng-*)
â”‚   â”œâ”€â”€ app.module.ts   # Module principal de l'application
â”‚   â””â”€â”€ app.routes.ts   # DÃ©finition des routes principales
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ i18n/           # Fichiers de traduction (fr.json, en.json)
â”‚   â””â”€â”€ ...             # Images, icÃ´nes, et autres ressources statiques
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ environment.ts
â”‚   â””â”€â”€ environment.prod.ts
â””â”€â”€ styles/
    â”œâ”€â”€ colors.scss     # DÃ©finition des palettes de couleurs du thÃ¨me
    â”œâ”€â”€ kng-theme.scss  # Fichier principal du thÃ¨me (variables, mixins)
    â”œâ”€â”€ styles.scss     # Styles globaux de l'application
    â””â”€â”€ ...             # Autres fichiers de styles partiels
```

## 3. Conventions de Nommage et de Codage

### TypeScript / Angular

-   **Modules / Composants / Services :** Les noms de classes utilisent `PascalCase`. Les noms de fichiers utilisent `kebab-case` et sont suffixÃ©s par leur type (`.component.ts`, `.service.ts`, `.module.ts`).
    -   Exemple : Classe `KngHomeComponent` dans le fichier `kng-home.component.ts`.

-   **PrÃ©fixe `kng-` :** Ce prÃ©fixe est utilisÃ© pour les composants et modules spÃ©cifiques Ã  l'application afin d'Ã©viter les conflits de nommage avec des bibliothÃ¨ques externes.

-   **Variables et MÃ©thodes :** Les noms de variables et de mÃ©thodes utilisent `camelCase`.
    -   Exemple : `currentContract`, `getPaymentErrorMessage()`.

-   **Services et Observables :** Les propriÃ©tÃ©s qui contiennent une instance de service (injectÃ©e via le constructeur) ou un `Observable` important peuvent Ãªtre prÃ©fixÃ©es par un `$` pour les identifier rapidement.
    -   Exemple : `this.$cart`, `this.$user`.
    Utiliser une approche dÃ©clarative pour se dÃ©sabonner des observables (ex: `pipe(takeUntil(destroyed$))`)

-  **EvÃ©nements des composants :** Les noms des mÃ©thodes d'Ã©vÃ©nnements sont  prÃ©fixÃ©es par `on`

### Styles (SCSS)

Cette section dÃ©taille l'architecture et les conventions de style du projet. Une adhÃ©sion stricte Ã  ces rÃ¨gles est essentielle pour maintenir un design cohÃ©rent et faciliter la personnalisation du thÃ¨me.

#### **MÃ©thodologie GÃ©nÃ©rale**

-   **Encapsulation :** Les styles sont encapsulÃ©s au niveau des composants par dÃ©faut (`ViewEncapsulation.None` est Ã  Ã©viter). Cela empÃªche les styles d'un composant de "fuir" et d'affecter d'autres parties de l'application.
-   **Fichiers Globaux :** Les styles qui doivent s'appliquer Ã  toute l'application (comme les dÃ©finitions de variables, les resets CSS, etc.) sont placÃ©s dans le rÃ©pertoire `src/styles/`.

#### **Le SystÃ¨me de Theming : Variables CSS (Custom Properties)**

Le cÅ“ur du systÃ¨me de theming repose sur les **variables CSS**, aussi appelÃ©es "Custom Properties".

-   **DÃ©finition :** Toutes les variables de thÃ¨me globales sont dÃ©finies dans `src/styles/styles.scss` sous le sÃ©lecteur `:root`. Cela les rend disponibles dans l'ensemble de l'application.
-   **Avantages :**
    -   **Centralisation :** Toutes les valeurs de design clÃ©s (couleurs, dimensions) sont Ã  un seul endroit.
    -   **Personnalisation Facile :** Modifier une variable dans `:root` met Ã  jour sa valeur partout oÃ¹ elle est utilisÃ©e, permettant de "re-skinner" l'application trÃ¨s facilement.
    -   **Dynamisme :** Les variables CSS peuvent Ãªtre modifiÃ©es Ã  la volÃ©e avec JavaScript, ouvrant la voie Ã  des thÃ¨mes dynamiques (ex: mode sombre/clair).

#### **Utilisation Pratique**

Pour utiliser une variable de thÃ¨me dans le fichier SCSS d'un composant, utilisez la fonction `var()` :

```scss
// Exemple dans un composant
.mon-bouton-principal {
  background-color: var(--mdc-theme-primary);
  color: var(--mdc-theme-primary-text);
  border: 1px solid var(--mdc-theme-secondary);
}

.conteneur-page {
  width: 100%;
  max-width: var(--mdc-theme-max-width-md);
  margin: 0 auto;
}
```

#### **Variables de ThÃ¨me Essentielles**

Voici une liste des variables les plus importantes Ã  connaÃ®tre et Ã  utiliser.

##### **Palette de Couleurs**

| Variable                                   | RÃ´le                                                                 |
| ------------------------------------------ | -------------------------------------------------------------------- |
| `--mdc-theme-primary`                      | **Couleur principale** de la marque. UtilisÃ©e pour les en-tÃªtes, les boutons principaux, etc. |
| `--mdc-theme-secondary`                    | **Couleur d'accentuation**. UtilisÃ©e pour les Ã©lÃ©ments interactifs secondaires, les liens, etc. |
| `--mdc-theme-primary-light` / `--secondary-light` | Versions Ã©claircies, souvent gÃ©nÃ©rÃ©es via `color-mix`, pour les fonds ou les survols (`hover`). |
| `--mdc-theme-primary-text` / `--secondary-text`   | Couleur du texte Ã  utiliser **par-dessus** les couleurs primaires/secondaires. |
| `--mdc-theme-text-primary-on-background`   | Couleur du **texte par dÃ©faut** sur un fond clair.                   |
| `--mdc-theme-text-secondary-on-background` | Couleur du texte secondaire, moins important (sous-titres, etc.).  |
| `--mdc-theme-text-hint-on-background`      | Couleur pour les textes d'aide ou les placeholders.                  |
| `--mdc-theme-text-icon-on-background`      | Couleur des icÃ´nes par dÃ©faut.                                       |
| `--mdc-theme-background-container`         | Couleur de **fond principale** de l'application.                     |
| `--mdc-theme-appbar`                       | Couleur de fond de la barre de navigation.                           |
| `--mdc-theme-appbar-text`                  | Couleur du texte et des icÃ´nes dans la barre de navigation.          |

##### **Dimensions et Layout**

| Variable                      | RÃ´le                                                                 |
| ----------------------------- | -------------------------------------------------------------------- |
| `--mdc-theme-width-md`        | Largeur fixe du conteneur principal pour les Ã©crans de taille moyenne (desktop). |
| `--mdc-theme-max-width-md`    | Largeur **maximale** du conteneur principal pour les Ã©crans de taille moyenne. |
| `--mdc-theme-top-bar`         | **Hauteur de la barre de navigation** (`70px`). Essentiel pour positionner le contenu de la page en dessous avec `padding-top` ou `margin-top`. |


## 4. DÃ©pendances ClÃ©s

Le projet repose sur un ensemble de dÃ©pendances fondamentales.

-   **`@kng2-core` (DÃ©pendance Principale) :**
    -   **RÃ´le :** C'est le cÅ“ur de l'application. Cette bibliothÃ¨que contient la logique mÃ©tier, les modÃ¨les de donnÃ©es, et les services principaux qui ne sont pas liÃ©s Ã  l'interface utilisateur.
    -   **Contenu :**
        -   **Services :** `CartService`, `UserService`, `ProductService`, `ConfigService`.
        -   **ModÃ¨les :** Interfaces comme `User`, `Product`, `Order`, `CartSubscription`.
    -   **Convention :** Toute la logique mÃ©tier (appels API, gestion de l'Ã©tat du panier, etc.) doit Ãªtre dÃ©lÃ©guÃ©e aux services de `@kng2-core`. Les composants Angular doivent rester aussi simples que possible et consommer ces services.

-   **`@angular-mdc/web` :** BibliothÃ¨que de composants UI basÃ©e sur Material Design (DEPRECATED, il faut supprimer cette dÃ©pendance).

-   **`ngx-stripe` :** IntÃ©gration pour la gestion des paiements via Stripe.

-   **`@sentry/angular-ivy` :** Suivi et rapport d'erreurs.

## 5. Gestion de l'Ã‰tat (State Management)

L'Ã©tat de l'application (panier, utilisateur connectÃ©, etc.) est gÃ©rÃ© de maniÃ¨re rÃ©active Ã  l'aide de **RxJS**. Les services de `@kng2-core` exposent des `Observables` (souvent basÃ©s sur des `BehaviorSubject`) auxquels les composants s'abonnent pour recevoir les mises Ã  jour de l'Ã©tat en temps rÃ©el.

-   **Exemple :**
    ```typescript
    // Dans un composant, pour suivre les changements de l'utilisateur
    this.$user.user$.subscribe(user => {
      this.user = user;
    });
    ```
-   **Convention :** Utiliser le pipe `async` dans les templates autant que possible pour gÃ©rer automatiquement les souscriptions et dÃ©sabonnements, afin d'Ã©viter les fuites de mÃ©moire.


## 5.1 Convention
- utliser  `const $date = new DatePipe('fr-ch');` pour formater une date.

## 6. StratÃ©gie de Routage et de Cache

Le fichier `app.cache.route.ts` implÃ©mente une stratÃ©gie de rÃ©utilisation des routes (`RouteReuseStrategy`) personnalisÃ©e. C'est une piÃ¨ce maÃ®tresse pour la performance et la fluiditÃ© de la navigation.

-   **Objectif :** AmÃ©liorer l'expÃ©rience utilisateur en mettant en cache les vues des composants dÃ©jÃ  visitÃ©s. Cela permet d'Ã©viter de re-dÃ©truire et re-crÃ©er des composants Ã  chaque navigation, conservant ainsi l'Ã©tat de la vue (comme la position de dÃ©filement) et Ã©vitant des appels rÃ©seau inutiles.

-   **Fonctionnement :**
    -   La classe `CacheRouteReuseStrategy` dÃ©termine, pour chaque navigation, s'il faut dÃ©tacher et stocker la vue actuelle ou attacher une vue prÃ©cÃ©demment stockÃ©e.
    -   La mise en cache est sÃ©lective et basÃ©e sur le chemin des routes. Par exemple, elle est configurÃ©e pour mettre en cache les listes de produits (`category/:category`) lorsque l'utilisateur navigue vers une page de dÃ©tail produit (`products/:sku`) et revient en arriÃ¨re.
    -   Le cache est intelligemment invalidÃ©, notamment lorsque l'utilisateur change de "dÃ©partement" principal (ex: passer de `home` Ã  `cellar`), afin de ne pas conserver un Ã©tat de cache incohÃ©rent.

## 7. Plan d'IntÃ©gration Calendar API dans kng2-core

### **Contexte et ProblÃ©matique**

Le projet nÃ©cessite une harmonisation des dates et timezones selon le plan de migration [[memory:5460294]]. L'analyse des sources a rÃ©vÃ©lÃ© des **bugs critiques** dans `kng2-core` par rapport Ã  l'API Calendar backend (testÃ©e).

## RÃ©sumÃ© de la StratÃ©gie

### **âš ï¸ DIFFÃ‰RENCE CRITIQUE BACKEND vs FRONTEND**

#### **Backend (calendar.js)** : UTC-First âœ…
- **Principe** : UTC partout, conversion Hub seulement pour calculs business
- **`new Date()`** â†’ UTC normalisÃ© (serveur contrÃ´lÃ©)
- **currentRanks indexing** : `day.getUTCDay()` car dates UTC
- **Transport** : UTC entre services

#### **Frontend (CalendarService)** : **ğŸš¨ HUB-CENTRIC-TIMEZONE OBLIGATOIRE** ğŸš¨

## **ğŸ¯ SPÃ‰CIFICATIONS CORRECTES VALIDÃ‰ES**

### **Configuration Hub (SPEC FINALE)** :
```typescript
hub = {
  timelimit: 12,          // âœ… 12h de prÃ©paration par dÃ©faut (CORRIGÃ‰)
  timelimitH: 10,         // âœ… Collecte Ã  10h par dÃ©faut (CORRIGÃ‰)
  weekdays: [1,2,3,4,5,6], // Jours de livraison disponibles
  timezone: 'Europe/Zurich' // Timezone du marchÃ©
}
```

### **Logique MÃ©tier Correcte** :
```typescript
// âœ… EXEMPLE VALIDÃ‰ (Tests 100% rÃ©ussis) :
// Hub normal: collecte demain 10h - prÃ©paration 12h = deadline aujourd'hui 22h
// Pain frais: collecte demain 10h - prÃ©paration 24h = deadline hier 10h (plus restrictif!)

// product.attributes.timelimit = DURÃ‰E DE PRÃ‰PARATION (remplace hub.timelimit)
// Si product.timelimit = 24h > hub.timelimit = 12h â†’ utilise 24h (plus restrictif)
```

### **API CalendarService SimplifiÃ©e - 2 FONCTIONS PRINCIPALES** :
```typescript
export class CalendarService {

  // ============================================================================
  // FONCTION PRINCIPALE 1/2 : Dates de livraison disponibles
  // ============================================================================
  getValidShippingDatesForHub(hub?: Hub, options?: {
    days?: number,        // Nombre de jours Ã  chercher (dÃ©faut: 7)
    detailed?: boolean    // Format dÃ©taillÃ© avec timezone info
  }): Date[] | DetailedDate[] {
    // Retourne les dates de livraison disponibles
  }

  // ============================================================================
  // FONCTION PRINCIPALE 2/2 : Temps restant + Interface complÃ¨te
  // ============================================================================
  timeleftBeforeCollect(
    hub?: Hub,
    productTimelimit?: number,  // DurÃ©e prÃ©paration spÃ©cifique produit
    when?: Date,                // Date de livraison choisie
    options?: { includeInterface?: boolean }
  ): number | ProductOrderTiming {
    // Mode number: retourne heures restantes
    // Mode interface: retourne objet complet pour UI
  }

  // ============================================================================
  // AUTRES FONCTIONS : @deprecated (dÃ©lÃ¨guent vers les 2 principales)
  // ============================================================================
  // @deprecated Use getValidShippingDatesForHub(...)[0] instead
  nextShippingDay(hub?: Hub, user?: User): Date | null

  // @deprecated Use timeleftBeforeCollect with { includeInterface: true } instead
  getProductOrderTiming(product: any, hub?: Hub, options?: any): ProductOrderTiming
}
```

### **Interface ProductOrderTiming** :
```typescript
export interface ProductOrderTiming {
  isOutOfTimeLimit: boolean;      // Trop tard pour commander
  shouldShowCountdown: boolean;   // Afficher le countdown
  hoursLeft: number;             // Heures restantes (peut Ãªtre nÃ©gatif)
  formattedTimeLeft: string;     // "2 h 30 minutes" ou "45 minutes"
  formattedDeadline: string;     // "14h30" (heure de la deadline)
}
```

### **Principe HUB-CENTRIC Timezone** :
- **ProblÃ¨me critique** : `new Date()` retourne timezone CLIENT (Tokyo, NYC, Paris...)
- **Solution obligatoire** : **TOUT normaliser vers timezone Hub IMMÃ‰DIATEMENT**
- **Principe HUB-FIRST** : GÃ©nÃ©rer dates directement en timezone Hub
- **currentRanks indexing** : `day.getDay()` car dates dÃ©jÃ  en timezone Hub
- **RÃ¨gle absolue** : `toHubTime(new Date(), hub)` dÃ¨s gÃ©nÃ©ration

### **ğŸ¯ Pourquoi HUB-CENTRIC-TIMEZONE est CRITIQUE**

**ScÃ©nario rÃ©el** : Client Tokyo commande sur marchÃ© GenÃ¨ve
- âŒ **Sans normalisation** : `new Date()` â†’ JST â†’ calculs incohÃ©rents
- âœ… **Avec HUB-CENTRIC** : `toHubTime(new Date(), hub)` â†’ Swiss â†’ cohÃ©rent

**Impact** :
- âœ… **availableDays** : Toutes en timezone Swiss cohÃ©rent
- âœ… **currentRanks** : IndexÃ© par jour Swiss cohÃ©rent
- âœ… **Validation** : RÃ¨gles business appliquÃ©es timezone marchÃ©
- âœ… **International** : Clients monde entier â†’ mÃªme logique Swiss

### **ğŸ“‹ PATTERNS OBLIGATOIRES Frontend HUB-CENTRIC**

#### **âœ… CORRECT : Normalisation Hub ImmÃ©diate**
```typescript
// âœ… OBLIGATOIRE : Normaliser dÃ¨s gÃ©nÃ©ration
potentialShippingDay(hub?: Hub): Date {
  const nowHub = this.toHubTime(new Date(), hub); // âœ… Hub timezone immÃ©diat
  const potentialHub = new Date(nowHub.getTime() + 3600000 * hub.timelimit);
  return potentialHub; // âœ… Retour Hub timezone
}

// âœ… OBLIGATOIRE : Comparaisons directes en Hub timezone
if (hub.weekdays.indexOf(date.getDay()) === -1) { // âœ… getDay() car Hub timezone
  return false;
}

// âœ… OBLIGATOIRE : currentRanks avec getDay() (Hub timezone)
const dayRank = hubRanks[day.getDay()] || 0; // âœ… getDay() car Hub timezone
```

#### **âŒ INTERDIT : Logique UTC cÃ´tÃ© Frontend**
```typescript
// âŒ INTERDIT : UTC direct cÃ´tÃ© frontend
const now = new Date(); // âŒ Timezone client imprÃ©visible
const today = now.getUTCDay(); // âŒ UTC inadaptÃ© frontend

// âŒ INTERDIT : Conversion UTC â†’ Hub pour chaque usage
const dayInHubTz = this.toHubTime(day, hub); // âŒ Inefficace et source d'erreurs
const dayRank = hubRanks[dayInHubTz.getDay()] || 0; // âŒ Conversion rÃ©pÃ©tÃ©e
```

#### **ğŸ¯ RÃˆGLE D'OR Frontend**
> **"Generate Hub, Stay Hub, Display Hub"**
> 1. **Generate** : `toHubTime(new Date(), hub)` dÃ¨s crÃ©ation
> 2. **Stay** : Toutes les dates restent en timezone Hub
> 3. **Display** : `formatForClient()` pour affichage si nÃ©cessaire


**Objectif** : Centraliser toutes les fonctions de date liÃ©es aux livraisons, abonnements et planning.

### **ProblÃ¨mes IdentifiÃ©s** âŒ

1. **Logic Bug dans `order.ts`** :
   - `nextShippingDay()` a une logique incorrecte pour les pÃ©riodes de fermeture
   - `currentShippingDay()` est incomplÃ¨te et simpliste

2. **Timezone Bug dans `config.ts`** (RÃ‰SOLU via CalendarService) :
   - ~~`potentialShippingDay()` utilisait des mÃ©thodes incohÃ©rentes (mÃ©lange UTC/local)~~
   - âœ… **CORRIGÃ‰** : Utiliser `CalendarService.toHubTime()` pour normaliser vers timezone Hub
   - âœ… **PRINCIPE** : Frontend = Hub-Centric (Europe/Zurich), pas UTC

3. **Duplication de Code** :
   - Logique identique dupliquÃ©e entre `config.ts`, `order.ts` et `cart.service.ts`
   - Maintien difficile et source d'erreurs

### **Architecture de Solution** âœ…

#### **7.1 Principe de Convergence**

**TOUT CONVERGE VERS `$calendar`** - Abandon des calculs de dates dans `order.ts`

#### **7.2 CalendarService avec Convention Angular**

**CrÃ©ation de `kng2-core/src/calendar.service.ts`** :

#### **7.4 Migration cart.service.ts**

```typescript
@Injectable()
export class CartService {

  constructor(
    private $http: HttpClient,
    private $calendar: CalendarService // âœ… Convention Angular
  ) {}

  getCurrentShippingDay(): Date {
    if (!this.cache.currentShippingDay) {
      // âœ… DÃ‰LÃ‰GUER vers $calendar au lieu de Order.nextShippingDay()
      const hub = this.defaultConfig.shared.hub;
      return this.$calendar.nextShippingDay(hub);
    }
    return this.cache.currentShippingDay;
  }

  // âœ… Nouvelles mÃ©thodes utilisant $calendar
  validateShippingDay(date: Date, hub?: any): boolean {
    const targetHub = hub || this.defaultConfig.shared.hub;
    return this.$calendar.isShippingDayAvailable(targetHub, date);
  }
}
```

### **7.5 SÃ©paration des RÃ´les et Use Cases** ğŸ“‹

#### **Principe de SÃ©paration**
Il faut bien distinguer les diffÃ©rents rÃ´les dans la gestion des dates :

1. **`CalendarService`** : Logique pure de calcul des dates de livraison (business rules)
2. **`CartService`** : Gestion de l'Ã©tat et des prÃ©fÃ©rences utilisateur
3. **Composants** : Interface utilisateur et interactions

#### **Use Cases Principaux**

**UC1 - PremiÃ¨re Visite** :
```typescript
// 1. Utilisateur arrive sur le site
// 2. CalendarService calcule nextShippingDay() selon hub
// 3. CartService stocke comme currentShippingDay par dÃ©faut
this.cache.currentShippingDay = this.$calendar.nextShippingDay(hub);
```

**UC2 - Commande en Cours** :
```typescript
// 1. Utilisateur a une commande authorized/prepaid en cours
// 2. CartService.setContext() dÃ©tecte la commande pending
// 3. Date par dÃ©faut = date de la commande existante
if (!this.currentPendingOrder && order) {
  this.cache.currentShippingDay = new Date(order.shipping.when);
}
```

**UC3 - Changement de Date** :
```typescript
// 1. Utilisateur choisit une nouvelle date dans le calendrier
// 2. Composant appelle CartService.setShippingDay()
// 3. CartService sauvegarde la nouvelle prÃ©fÃ©rence
this.$cart.setShippingDay(newDate, hours); // => save() automatique
```

**UC4 - Validation Business** :
```typescript
// 1. Composant vÃ©rifie si une date est disponible
// 2. CalendarService applique les rÃ¨gles mÃ©tier
// 3. Retour boolean selon hub.weekdays + noshipping
const isValid = this.$calendar.isShippingDayAvailable(hub, date);
```

**UC5 - Multiple Commandes MÃªme Date** :
```typescript
// 1. CartService dÃ©tecte pending order mÃªme date
// 2. RÃ©duction shipping si mÃªme adresse + mÃªme jour
// 3. Interface affiche l'Ã©conomie rÃ©alisÃ©e
const hasReduction = this.$cart.hasShippingReductionMultipleOrder(address);
```

### **7.6 Gestion des DÃ©pendances et Ordre de Chargement** ğŸ”—

#### **ProblÃ©matique**
`CalendarService` dÃ©pend de `ConfigService` qui doit Ãªtre initialisÃ© avant utilisation.

#### **Solution : VÃ©rification de DÃ©pendance**

```typescript
// Dans CalendarService
private ensureConfigLoaded(): boolean {
  if (!this.$config.defaultConfig?.shared?.hub) {
    console.warn('CalendarService: ConfigService non chargÃ©, utilisation impossible');
    return false;
  }
  return true;
}

// Usage sÃ©curisÃ© avec hub optionnel
potentialShippingDay(hub?: Hub): Date {
  const targetHub = hub || this.getDefaultHub(); // âœ… Fallback si pas de hub
  // ... logique
}
```

#### **Patterns d'Usage RecommandÃ©s**

```typescript
// âœ… RECOMMANDÃ‰ : Passer hub explicitement
this.$calendar.nextShippingDay(this.currentHub)

// âœ… ACCEPTABLE : Hub par dÃ©faut (si config chargÃ©)
this.$calendar.nextShippingDay()

// âŒ Ã‰VITER : Usage sans vÃ©rifier config
// this.$calendar.nextShippingDay() // Peut Ã©chouer si config non chargÃ©
```

#### **Injection dans app.module.ts**

```typescript
// S'assurer que CalendarService est fourni aprÃ¨s ConfigService
@NgModule({
  providers: [
    ConfigService,      // âœ… Doit Ãªtre chargÃ© en premier
    CalendarService,    // âœ… Peut utiliser ConfigService
    // ... autres services
  ]
})
export class AppModule {}
```

### **Migration Progressive** ğŸ”„

#### **Ã‰tape 1 : CrÃ©ation CalendarService** âœ… **TERMINÃ‰**
- âœ… CrÃ©Ã© `calendar.service.ts` avec logique exacte de calendar.js testÃ©
- âœ… **CRITIQUE** : AjoutÃ© vÃ©rification dÃ©pendance ConfigService
- âœ… Documentation complÃ¨te des 7 use cases dans le service
- âœ… Export dans index.ts et intÃ©gration dans kng2-core.module.ts
- âœ… **CRITIQUE** : Ajout gestion `currentRanks` dans backend et frontend
- âœ… Support complet `user.isPremium()` pour limites Ã©tendues
- âœ… **Tests validÃ©s** : 32/33 tests passent, calendar.js prÃªt pour production

#### **Ã‰tape 2 : Injection dans config.ts et cart.service.ts** âœ… **TERMINÃ‰**
- âœ… MÃ©thodes config.ts marquÃ©es `@deprecated` avec warnings console
- âœ… Documentation complÃ¨te migrÃ©e vers CalendarService
- âœ… Bugs timezone identifiÃ©s et documentÃ©s dans config.ts
- âœ… Ajout mÃ©thode `noShippingMessage()` dans CalendarService
- âœ… **CRITIQUE** : Ajout gestion `currentRanks` dans backend et frontend
- âœ… Support complet `user.isPremium()` pour limites Ã©tendues
- ğŸ”² Injection `$calendar` dans cart.service.ts Ã  faire

#### **Ã‰tape 3 : Abandon order.ts pour les dates**
- Supprimer `nextShippingDay()`, `currentShippingDay()`, `fullWeekShippingDays()`
- Redirection vers `$calendar` service
- VÃ©rifier que tous les appels passent un hub explicite

#### **Ã‰tape 4 : Nettoyage**
- Supprimer mÃ©thodes dÃ©prÃ©ciÃ©es
- Tests de rÃ©gression complets
- Documentation mise Ã  jour

### **Avantages** âœ…

1. **Correction des Bugs** : Logique testÃ©e de calendar.js
2. **Harmonisation UTC** : RÃ©sout les problÃ¨mes de timezone
3. **Single Source of Truth** : Tout converge vers `$calendar`
4. **Convention Angular** : Respect des patterns `$service`
5. **Migration Progressive** : Pas de breaking changes

# 8. Plan de Migration Frontend SimplifiÃ© ğŸ¯

## **Objectif Principal**
Assurer l'affichage correct des dates en timezone Europe/Zurich et corriger les bugs de timezone dans le frontend.

## **Architecture Cible**
- âœ… **Backend Calendar API** : UTC-First (dÃ©jÃ  testÃ© et fonctionnel)
- âœ… **Frontend CalendarService** : DÃ©lÃ©gation vers backend (dÃ©jÃ  implÃ©mentÃ© dans kng2-core)
- ğŸ¯ **Composants Frontend** : Migration vers `$calendar` pour timezone Swiss

## **Principe de Migration**
**UTC-First avec Affichage Swiss** : Le backend calcule en UTC, le frontend affiche en Europe/Zurich.

---

## **Phase 1 : Migration Prioritaire (Bugs Critiques)**

### **Ã‰tape 1.1 : Injection CalendarService**
Pour les composants prioritaires, ajouter l'injection :

```typescript
// Pattern standard pour tous les composants
constructor(
  private $cart: CartService,
  private config: Config,
  private $calendar: CalendarService // âœ… Nouvelle injection
) {}
```

### **Ã‰tape 1.2 : Remplacement des Appels BuggÃ©s**

**Pattern de Migration Simple** :

```typescript
// âŒ AVANT (bugs timezone)
Order.nextShippingDay(this.user, this.hub)
Order.fullWeekShippingDays(this.hub)
this.config.timeleftBeforeCollect(hub, limit, when) // â† BUG CRITIQUE
this.config.getDefaultTimeByDay(day) // â† DISPERSÃ‰
this.isDayAvailable(day) // â† LOGIQUE DUPLIQUÃ‰E

// âœ… APRÃˆS (timezone Swiss correct + centralisÃ©)
this.$calendar.nextShippingDay(this.hub)
this.$calendar.getValidShippingDatesForHub(this.hub, { days: 7 }) // â† PLUS FLEXIBLE
this.$calendar.timeleftBeforeCollect(hub, limit, when) // â† CORRIGÃ‰
this.$calendar.getDefaultTimeByDay(day, this.hub) // â† CENTRALISÃ‰
this.$calendar.isDayAvailable(day, this.hub) // â† LOGIQUE UNIFIÃ‰E
```

### **Ã‰tape 1.3 : Composants Prioritaires Ã  Migrer**

**ğŸ”¥ CRITIQUE - product.component.ts** :
```typescript
// AVANT (affichage countdown incorrect)
this.config.timeleftBeforeCollect(this.config.shared.hub, this.product.attributes.timelimit, shippingDay)

// APRÃˆS (timezone Swiss correct)
this.$calendar.timeleftBeforeCollect(this.config.shared.hub, this.product.attributes.timelimit, shippingDay)
```

**ğŸ“… IMPORTANT - kng-calendar.component.ts** :
```typescript
// AVANT (logique dupliquÃ©e + limitÃ©e)
this.availableDays = Order.fullWeekShippingDays(this.currentHub);
const hours = this.config.getDefaultTimeByDay(day);
if (!this.isDayAvailable(day)) return;

// APRÃˆS (API complÃ¨te + timezone Swiss)
this.availableDays = this.$calendar.getValidShippingDatesForHub(this.currentHub, { days: 7 });
const hours = this.$calendar.getDefaultTimeByDay(day, this.currentHub);
if (!this.$calendar.isDayAvailable(day, this.currentHub)) return;
```

**ğŸ  ESSENTIEL - kng-home.component.ts** :
```typescript
// AVANT (duplication logique)
get currentShippingDay() {
  return this.$cart.getCurrentShippingDay() || Order.nextShippingDay(this.user,this.config.shared.hub);
}

// APRÃˆS (centralisÃ©)
get currentShippingDay() {
  return this.$cart.getCurrentShippingDay() || this.$calendar.nextShippingDay(this.config.shared.hub);
}
```

---

## **Phase 2 : Migration Standard (Composants Principaux)**

### **Liste des 7 Composants Ã  Migrer** :

1. **`kng-navbar/kng-navbar.component.ts`** - Status global ouvert/fermÃ©
2. **`kng-cart/kng-cart-items/kng-cart-items.component.ts`** - Validation panier
3. **`kng-cart/kng-cart.component.ts`** - Ã‰tat global panier
4. **`kng-cart/kng-cart-checkout/kng-cart-checkout.component.ts`** - Processus commande
5. **`kng-product/product-list.component.ts`** - Filtre produits par date
6. **`common/kng-subscription-option/kng-subscription-option.component.ts`** - Souscriptions
7. **`shared/kng-ui-bottom-actions/kng-ui-bottom-actions.component.ts`** - Actions recherche

### **Pattern Standard pour Tous** :
```typescript
// 1. Injection
constructor(..., private $calendar: CalendarService) {}

// 2. Remplacement direct
// AVANT: Order.nextShippingDay(...)
// APRÃˆS: this.$calendar.nextShippingDay(...)

// 3. Remplacement Cart
// AVANT: this.$cart.getCurrentShippingDay()
// APRÃˆS: Reste identique (le CartService utilise dÃ©jÃ  $calendar)
```

---

## **Phase 3 : Affichage Timezone Swiss**

### **MÃ©thode d'Affichage CentralisÃ©e avec Calendar**

```typescript
// âœ… UTILISER les fonctions Calendar au lieu de DateDisplayHelper
export class CalendarService {

  // Fonctions d'affichage Swiss intÃ©grÃ©es
  static formatForClient(utcDate: Date, hub?: Hub): string {
    const timezone = this.getHubTimezone(hub); // Europe/Zurich par dÃ©faut
    return new Intl.DateTimeFormat('fr-CH', {
      timeZone: timezone,
      weekday: 'long',
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    }).format(utcDate);
  }

  static weekdaysNames(lang = 'fr'): string[] {
    // Retourne les noms des jours selon la langue
    return lang === 'fr' ?
      ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'] :
      ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
  }

  static monthsNames(lang = 'fr'): string[] {
    // Retourne les noms des mois selon la langue
    return lang === 'fr' ?
      ['janvier', 'fÃ©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'aoÃ»t', 'septembre', 'octobre', 'novembre', 'dÃ©cembre'] :
      ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
  }
}
```

### **Usage dans les Composants** :
```typescript
// Dans les composants pour affichage Swiss automatique
get displayShippingDay(): string {
  const utcDate = this.$calendar.nextShippingDay(this.hub);
  return this.$calendar.formatForClient(utcDate, this.hub); // âœ… Swiss formatÃ©
}

get timeLeft(): string {
  const hoursLeft = this.$calendar.timeleftBeforeCollect(this.hub, this.product.timelimit, this.shippingDay);
  return `${Math.floor(hoursLeft)}h ${Math.floor((hoursLeft % 1) * 60)}m`;
}

// Noms de jours/mois localisÃ©s
get dayNames(): string[] {
  return this.$calendar.i18n_weekdays(this.locale); // fr/de selon utilisateur
}

get dayNamesShort(): string[] {
  return this.$calendar.i18n_weekdaysShort(this.locale); // 'lun.', 'mar.', etc.
}

get monthNames(): string[] {
  return this.$calendar.i18n_months(this.locale); // fr/de selon utilisateur
}

// Helper pour un jour spÃ©cifique
getWeekDay(idx: number): string {
  return this.$calendar.getWeekDay(idx, this.locale); // 'lun.', 'mar.', etc.
}
```

---

## **Tests de Validation** ğŸ§ª

### **Tests Critiques Obligatoires** :

1. **Countdown Produit** : Temps restant affichÃ© en heure Swiss âœ…
2. **Calendrier Navigation** : Jours disponibles en timezone Swiss âœ…
3. **Status Navbar** : Ouvert/fermÃ© selon heure Swiss âœ…
4. **Validation Panier** : Dates de livraison cohÃ©rentes âœ…

### **ScÃ©narios de Test** :
```typescript
// Test 1: Client international, affichage Swiss
// UTC: 2024-01-15T14:00:00.000Z (14h UTC)
// Swiss: Affichage "15h" (hiver) ou "16h" (Ã©tÃ©)

// Test 2: Limite de commande
// Hub timelimitH: 10 (10h Swiss - SPEC CORRECTE)
// Commande Ã  09h Swiss â†’ OK
// Commande Ã  11h Swiss â†’ KO (trop tard)

// Test 3: Changement DST (Ã©tÃ©/hiver)
// Dates consistent entre backend UTC et affichage Swiss
```

---

## **Checklist de Migration** âœ…

### **Phase 1 - Critique (2-3 jours)**
- [ ] **product.component.ts** : Fix countdown timezone
- [ ] **kng-calendar.component.ts** : Fix sÃ©lection dates
- [ ] **kng-home.component.ts** : Fix affichage date principale

### **Phase 2 - Standard (3-4 jours)**
- [ ] **kng-navbar.component.ts** : Migration status
- [ ] **kng-cart-items.component.ts** : Migration validation
- [ ] **4 autres composants** : Migration standard

### **Phase 3 - Affichage (1-2 jours)**
- [ ] **toHubTime/toUTC** : ImplÃ©mentation conversions timezone
- [ ] **formatForClient** : Formatage Swiss automatique
- [ ] **weekdaysNames/monthsNames** : Localisation fr/de
- [ ] **Tests e2e** : Validation timezone complÃ¨te

### **Livrable Final**
- âœ… **Affichage Swiss** : Toutes les dates en Europe/Zurich
- âœ… **Logique UTC** : Transport et calculs en UTC
- âœ… **Single Source** : Calendar API backend comme rÃ©fÃ©rence
- âœ… **Zero Bug** : Timezone cohÃ©rent partout

---

## **Avantages de ce Plan SimplifiÃ©**

1. **Focus Timezone** : Se concentre sur l'objectif principal (affichage Swiss)
2. **Migration Progressive** : Phase par phase sans breaking changes
3. **Tests Concrets** : ScÃ©narios timezone spÃ©cifiques
4. **RÃ©sultat Mesurable** : Countdown et calendrier justes en heure Swiss

**DurÃ©e EstimÃ©e** : 6-9 jours de dÃ©veloppement avec validation timezone garantie ğŸ‡¨ğŸ‡­

---

## **ğŸ“‹ ComplÃ©ments selon vos Remarques**

### **Fonctions Calendar Essentielles Manquantes**

Votre analyse rÃ©vÃ¨le **5 fonctions critiques** Ã  implÃ©menter dans `CalendarService` :

#### **1. Conversion Timezone (UTC â†” Swiss)**
```typescript
// OBLIGATOIRE pour calculs business Swiss
static toHubTime(utcDate: Date, hub: Hub): Date {
  const timezone = hub?.timezone || 'Europe/Zurich';
  // Convertit UTC vers timezone hub pour comparaisons
}

static toUTC(hubDate: Date, hub: Hub): Date {
  const timezone = hub?.timezone || 'Europe/Zurich';
  // Reconvertit timezone hub vers UTC pour stockage
}
```

#### **2. API Flexible pour Dates de Livraison**
```typescript
// âœ… REMPLACE fullWeekShippingDays (plus flexible)
static getValidShippingDatesForHub(hub: Hub, options = {}): Date[] {
  const { days = 7, limit = 10, offset = 0 } = options;
  // Logique identique Ã  backend calendar.js
}
```

#### **3. Validation et Heure par DÃ©faut**
```typescript
// âœ… CENTRALISE la logique de validation
// availableDays et currentRanks reprÃ©sentent dÃ©jÃ  les jours dans timezone du marchÃ©
static isDayAvailable(day: Date, availableDays: Date[]): boolean {
  // Validation simple: vÃ©rifier si le jour est dans la liste disponible
  return availableDays.some(date => date.equalsDate(day));
}

// âœ… CENTRALISE la logique d'heure par dÃ©faut
static getDefaultTimeByDay(day: Date, hub: Hub): number {
  // Retourne l'heure par dÃ©faut selon jour (16h normalement, 12h samedi)
  // day peut Ãªtre UTC (du backend) ou Hub timezone (frontend)
  // La fonction utilise toHubTime() pour normaliser avant comparaison
}
```

#### **4. Localisation et Internationalisation**
```typescript
// âœ… SUPPORT multilingue pour interface
static weekdaysNames(lang = 'fr'): string[] // ['lundi', 'mardi'...]
static monthsNames(lang = 'fr'): string[]  // ['janvier', 'fÃ©vrier'...]

// âœ… NOUVELLES fonctions i18n centralisÃ©es
static getWeekDay(idx: number, lang = 'fr'): string // 'lun.', 'mar.', etc.
static i18n_weekdays(lang = 'fr'): string[] // Noms complets des jours
static i18n_weekdaysShort(lang = 'fr'): string[] // Noms courts des jours
static i18n_months(lang = 'fr'): string[] // Noms des mois
```

### **Impact des Fonctions Manquantes**

#### **ğŸ”¥ CRITIQUE : kng-calendar.component.ts**
```typescript
// âŒ Ã‰TAT ACTUEL (logique dupliquÃ©e + bugs)
this.availableDays = Order.fullWeekShippingDays(this.currentHub); // LimitÃ©
const hours = this.config.getDefaultTimeByDay(day); // Config dispersÃ©e
if (!this.isDayAvailable(day)) return; // Logique incomplÃ¨te currentRanks

// âœ… APRÃˆS MIGRATION (API complÃ¨te avec timezone correct)
this.availableDays = this.$calendar.getValidShippingDatesForHub(this.currentHub, { days: 7 });
const hours = this.$calendar.getDefaultTimeByDay(day, this.currentHub);
// isDayAvailable simplifiÃ©: day UTC vs availableDays (timezone marchÃ©)
if (!this.$calendar.isDayAvailable(day, this.availableDays)) return;
```

#### **ğŸ“Š IMPACT : Composants DÃ©pendants**

**Fonctions getDefaultTimeByDay** :
1. **kng-calendar.component.ts** : Composant central de sÃ©lection dates
2. **kng-home.component.ts** : FIXME ligne 564 - getDefaultTimeByDay dÃ©prÃ©ciÃ©
3. **kng-cart.component.ts** : Ligne 301 - fallback getDefaultTimeByDay
4. **kng-cart-items.component.ts** : FIXME ligne 556 - getDefaultTimeByDay dÃ©prÃ©ciÃ©

**Fonctions i18n dispersÃ©es** :
1. **kng-nav-marketplace.component.ts** : ligne 144 - getWeekDay dupliquÃ©
2. **Autres composants** : Utilisation de `this.$i18n.label().weekdays` dispersÃ©e

### **Plan RÃ©visÃ© avec PrioritÃ©s (Migration Progressive - Zero Downtime)**

#### **Phase 0 - COMPLETION CalendarService (kng2-core)**
- [ ] **Ajouter 10 fonctions manquantes** : toHubTime, toUTC, isDayAvailable (2 params), getDefaultTimeByDay, formatForClient, i18n functions
- [ ] **Tests CalendarService** : Valider toutes les nouvelles fonctions
- [ ] **Publication kng2-core** : Version avec API complÃ¨te (rÃ©trocompatible)
- [ ] **âŒ NE PAS TOUCHER** : cart.service.ts, order.ts, config.ts (gardent anciennes fonctions)

#### **Phase 1 - MIGRATION kng2-core Interne**
- [ ] **cart.service.ts** : Remplacer Order.* par CalendarService.* (+ injection)
- [ ] **config.ts** : Migrer getDefaultTimeByDay vers CalendarService
- [ ] **@deprecated** : Marquer order.ts functions comme dÃ©prÃ©ciÃ©es
- [ ] **Tests kng2-core** : Valider migration interne
- [ ] **Publication kng2-core** : Version avec migration interne

#### **Phase 2 - MIGRATION Frontend Progressive**
- [ ] **Injection CalendarService** : Ajouter dans 17 composants (sans utilisation)
- [ ] **Migration Composant par Composant** : 1 composant â†’ test â†’ validation â†’ suivant
- [ ] **Ordre Prioritaire** : Critiques â†’ Principaux â†’ Secondaires
- [ ] **Tests e2e** : Validation aprÃ¨s chaque composant migrÃ©

Cette approche garantit **zÃ©ro rÃ©gression** et **timezone Swiss parfait** ! ğŸ‡¨ğŸ‡­âœ…

---

## **ğŸš¦ StratÃ©gie Migration Zero Downtime**

### **Principe Fondamental : CompatibilitÃ© Ascendante**

**Ã€ CHAQUE Ã‰TAPE** : Le systÃ¨me reste **100% fonctionnel** sans interruption de service.

#### **ğŸ”§ Phase 0 : Completion CalendarService (kng2-core)**

**Objectif** : Ajouter les fonctions manquantes **SANS CASSER** l'existant

```typescript
// âœ… AJOUTER les nouvelles fonctions (statiques)
export class CalendarService {

  // === NOUVELLES FONCTIONS (n'affectent pas l'existant) ===
  static toHubTime(utcDate: Date, hub: Hub): Date { /* ... */ }
  static isDayAvailable(day: Date, availableDays: Date[]): boolean { /* ... */ }
  static getDefaultTimeByDay(day: Date, hub: Hub): number { /* ... */ }
  static formatForClient(utcDate: Date, hub?: Hub): string { /* ... */ }
  static getWeekDay(idx: number, lang: string): string { /* ... */ }

  // === FONCTIONS EXISTANTES (inchangÃ©es) ===
  nextShippingDay(hub?: Hub, user?: any): Date { /* EXISTANT - NO CHANGE */ }
  fullWeekShippingDays(hub?: Hub, limit?: number, user?: any): Date[] { /* EXISTANT - NO CHANGE */ }
}
```

**âœ… GARANTIE ZÃ‰RO RÃ‰GRESSION** :
- âœ… Aucune fonction existante modifiÃ©e
- âœ… Ajout seulement de nouvelles fonctions
- âœ… Tests passent toujours
- âœ… Frontend fonctionne encore avec anciennes fonctions

#### **ğŸ”„ Phase 1 : Migration kng2-core Interne**

**Objectif** : Migrer cart.service.ts **GRADUELLEMENT**

```typescript
// âœ… PATTERN : Injection + Fallback Progressif
@Injectable()
export class CartService {

  constructor(
    private $http: HttpClient,
    private $calendar: CalendarService // âœ… AJOUT : Nouvelle injection
  ) {}

  // âœ… MIGRATION FONCTION PAR FONCTION
  getCurrentShippingDay(): Date {
    if (!this.cache.currentShippingDay) {
      // âœ… NOUVEAU : Utiliser CalendarService
      const hub = this.defaultConfig.shared.hub;
      return this.$calendar.nextShippingDay(hub);

      // âŒ ANCIEN (commentÃ©, mais garde fallback)
      // return Order.nextShippingDay(this.currentUser, hub);
    }
    return this.cache.currentShippingDay;
  }
}
```

**âœ… STRATÃ‰GIE GRADUELLE** :
1. **Semaine 1** : Injection CalendarService (pas d'utilisation)
2. **Semaine 2** : Migrer 1-2 fonctions + tests
3. **Semaine 3** : Migrer 2-3 fonctions + tests
4. **Semaine 4** : Finaliser + @deprecated order.ts

#### **ğŸ¯ Phase 2 : Migration Frontend Progressive**

**Objectif** : Migrer **1 composant Ã  la fois** avec validation complÃ¨te

```typescript
// âœ… Ã‰TAPE 2.1 : Injection SANS utilisation (tous composants)
export class KngCalendarComponent {
  constructor(
    private $cart: CartService,
    private config: Config,
    private $calendar: CalendarService // âœ… AJOUT : Injection prÃªte
  ) {}

  // âŒ ANCIEN : Reste inchangÃ© temporairement
  ngOnInit() {
    this.availableDays = Order.fullWeekShippingDays(this.currentHub); // PAS ENCORE MIGRÃ‰
  }
}

// âœ… Ã‰TAPE 2.2 : Migration fonction par fonction
export class KngCalendarComponent {
  ngOnInit() {
    // âœ… NOUVEAU : Migration progressive
    this.availableDays = this.$calendar.getValidShippingDatesForHub(this.currentHub, { days: 7 });

    // âŒ ANCIEN : CommentÃ© mais disponible pour rollback
    // this.availableDays = Order.fullWeekShippingDays(this.currentHub);
  }
}
```

**âœ… ORDRE DE MIGRATION SÃ‰CURISÃ‰** :

**Semaine 1 - Injection PrÃ©paratoire** :
- [ ] Ajouter injection CalendarService dans les 17 composants
- [ ] Tests : VÃ©rifier que rien ne casse
- [ ] **AUCUNE logique changÃ©e**

**Semaine 2 - Composants Critiques** :
- [ ] **kng-product.component.ts** : Fix timezone countdown (1 ligne)
- [ ] **Tests e2e** : VÃ©rifier countdown correct
- [ ] **kng-calendar.component.ts** : Migration complÃ¨te (3 fonctions)
- [ ] **Tests e2e** : VÃ©rifier sÃ©lection dates

**Semaine 3 - Composants Principaux** :
- [ ] **kng-home.component.ts** : Migration (1 fonction)
- [ ] **kng-navbar.component.ts** : Migration (2 fonctions)
- [ ] **Tests e2e** : VÃ©rifier navigation

**Semaine 4 - Composants Cart** :
- [ ] **kng-cart*.component.ts** : Migration (5 fonctions)
- [ ] **Tests e2e** : VÃ©rifier processus commande

**Semaine 5 - Composants Secondaires** :
- [ ] **8 composants restants** : Migration + i18n
- [ ] **Tests e2e complets** : Validation globale

### **ğŸ›¡ï¸ MÃ©canismes de SÃ©curitÃ©**

#### **Rollback InstantanÃ©**
```typescript
// âœ… En cas de problÃ¨me : Rollback immÃ©diat
ngOnInit() {
  try {
    // âœ… NOUVEAU : Logic CalendarService
    this.availableDays = this.$calendar.getValidShippingDatesForHub(this.currentHub, { days: 7 });
  } catch (error) {
    // ğŸš¨ FALLBACK : Ancienne logique en cas d'erreur
    console.warn('CalendarService error, falling back to Order logic:', error);
this.availableDays = Order.fullWeekShippingDays(this.currentHub);
  }
}
```

#### **Tests AutomatisÃ©s Ã  Chaque Ã‰tape**
- âœ… **Tests unitaires** : Chaque fonction CalendarService
- âœ… **Tests d'intÃ©gration** : CartService aprÃ¨s migration
- âœ… **Tests e2e** : AprÃ¨s chaque composant migrÃ©
- âœ… **Tests de rÃ©gression** : Suite complÃ¨te avant dÃ©ploiement

#### **Feature Flags (Optionnel)**
```typescript
// âœ… OPTION : Feature flag pour activation progressive
ngOnInit() {
  if (this.config.features?.useCalendarService) {
    this.availableDays = this.$calendar.getValidShippingDatesForHub(this.currentHub, { days: 7 });
  } else {
    this.availableDays = Order.fullWeekShippingDays(this.currentHub);
  }
}
```

### **ğŸ“ˆ Avantages Migration Progressive**

1. **âœ… Zero Downtime** : Service jamais interrompu
2. **âœ… Risk Minimization** : 1 composant = 1 risque isolÃ©
3. **âœ… Quick Rollback** : Retour arriÃ¨re immÃ©diat si problÃ¨me
4. **âœ… Incremental Testing** : Validation continue
5. **âœ… Team Confidence** : Ã‰quipe rassurÃ©e par approche graduelle
6. **âœ… Business Continuity** : Aucun impact utilisateur

**Cette stratÃ©gie garantit une migration rÃ©ussie avec ZÃ‰RO interruption de service !** ğŸ›¡ï¸ğŸš€

---

## **ğŸ¯ Clarifications Timezone Critiques**

### **Principe Central : UTC-First avec Timezone MarchÃ© pour Business**

#### **1. DonnÃ©es en UTC (Transport/Stockage)**
```typescript
// âœ… TOUJOURS UTC pour transport et stockage
const shippingDay = new Date('2024-01-15T16:00:00.000Z'); // UTC
this.$cart.setShippingDay(shippingDay, hours); // EnvoyÃ© UTC au backend
```

#### **2. availableDays et currentRanks : Timezone MarchÃ©**
```typescript
// âœ… Les listes disponibles sont dÃ©jÃ  dans timezone du marchÃ©
this.availableDays = this.$calendar.getValidShippingDatesForHub(hub, { days: 7 });
this.currentRanks = config.shared.currentRanks[hub.slug] || {};

// âœ… currentRanks indexÃ© par jour de semaine du marchÃ©
// currentRanks[0] = dimanche Swiss, currentRanks[1] = lundi Swiss, etc.
```

#### **3. isDayAvailable : Signature SimplifiÃ©e**
```typescript
// âœ… NOUVEAU : signature simplifiÃ©e avec 2 paramÃ¨tres
static isDayAvailable(day: Date, availableDays: Date[]): boolean {
  // day = UTC, availableDays = dÃ©jÃ  filtrÃ©es timezone marchÃ©
  return availableDays.some(date => date.equalsDate(day));
}

// âŒ ANCIEN : signature complexe avec hub/currentRanks
// static isDayAvailable(day: Date, hub: Hub, currentRanks?: any): boolean
```

#### **4. Comparaisons avec Hub Config : Conversion Needed**
```typescript
// âœ… Pour comparer avec hub.timelimitH (heure Swiss)
const dayHub = this.$calendar.toHubTime(day, hub); // UTC â†’ Swiss
if (dayHub.getHours() >= hub.timelimitH) { // Swiss vs Swiss âœ…

// âœ… Pour getDefaultTimeByDay
static getDefaultTimeByDay(day: Date, hub: Hub): number {
  // day est UTC, mais doit Ãªtre comparÃ© avec config hub Swiss
  const dayHub = Calendar.toHubTime(day, hub);
  return (dayHub.getDay() === 6) ? 12 : 16; // Samedi Swiss = 12h
}
```

#### **5. currentRanks Indexing : Timezone MarchÃ©**
```typescript
// âœ… currentRanks utilise les jours de semaine du marchÃ©
const dayOfWeekSwiss = Calendar.toHubTime(day, hub).getDay(); // 0-6 Swiss
const ordersCount = currentRanks[dayOfWeekSwiss] || 0;

// âŒ INCORRECT : utiliser UTC day directement
// const ordersCount = currentRanks[day.getUTCDay()] || 0;
```

### **Impact sur Calendar.js Backend**

#### **Fonctions Ã  Ajouter/Corriger**
```javascript
// âœ… isDayAvailable simplifiÃ© (2 paramÃ¨tres)
static isDayAvailable(day, availableDays) {
  return availableDays.some(date => date.equalsDate(day));
}

// âœ… getDefaultTimeByDay avec conversion Hub
static getDefaultTimeByDay(day, hub) {
  const dayHub = Calendar.toHubTime(day, hub);
  // Samedi Swiss = 12h, autres jours = 16h
  if (!hub?.shippingtimes) {
    return (dayHub.getDay() === 6) ? 12 : 16;
  }
  return hub.shippingtimes[dayHub.getDay()] || 16;
}

// âœ… Fonctions i18n centralisÃ©es
static getWeekDay(idx, lang = 'fr') {
  const weekdaysShort = Calendar.i18n_weekdaysShort(lang);
  return weekdaysShort[idx] || '';
}

static i18n_weekdays(lang = 'fr') {
  const i18n = {
    fr: ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'],
    en: ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'],
    de: ['sonntag', 'montag', 'dienstag', 'mittwoch', 'donnerstag', 'freitag', 'samstag']
  };
  return i18n[lang] || i18n.fr;
}

static i18n_weekdaysShort(lang = 'fr') {
  const i18n = {
    fr: ['dim.', 'lun.', 'mar.', 'mer.', 'jeu.', 'ven.', 'sam.'],
    en: ['sun.', 'mon.', 'tue.', 'wed.', 'thu.', 'fri.', 'sat.'],
    de: ['so.', 'mo.', 'di.', 'mi.', 'do.', 'fr.', 'sa.']
  };
  return i18n[lang] || i18n.fr;
}

static i18n_months(lang = 'fr') {
  const i18n = {
    fr: ['janvier', 'fÃ©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'aoÃ»t', 'septembre', 'octobre', 'novembre', 'dÃ©cembre'],
    en: ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'],
    de: ['januar', 'februar', 'mÃ¤rz', 'april', 'mai', 'juni', 'juli', 'august', 'september', 'oktober', 'november', 'dezember']
  };
  return i18n[lang] || i18n.fr;
}
```

### **Migration Frontend : Patterns CorrigÃ©s**

```typescript
// âŒ AVANT (timezone bugs + logique dispersÃ©e + i18n dupliquÃ©e)
if (!this.isDayAvailable(day)) return; // currentRanks logic manquante
const hours = this.config.getDefaultTimeByDay(day); // UTC vs Swiss bug
this.weekdays[this.locale] = this.$i18n.label().weekdays.split('_').map(day=>day.slice(0,3)+'.'); // âŒ DispersÃ©

// âœ… APRÃˆS (timezone correct + centralisÃ© + i18n service)
if (!this.$calendar.isDayAvailable(day, this.availableDays)) return; // âœ… Simple
const hours = this.$calendar.getDefaultTimeByDay(day, this.hub); // âœ… UTCâ†’Swiss conversion
const dayName = this.$calendar.getWeekDay(idx, this.locale); // âœ… i18n centralisÃ©
```

Cette architecture garantit **cohÃ©rence timezone** et **simplicitÃ© d'usage** ! ğŸ•ğŸ‡¨ğŸ‡­

## 9. ğŸš¨ MIGRATION KARIBOU-WALLET CRITIQUE - Ã‰LÃ‰MENTS FRONTEND Ã€ NE PAS OUBLIER

### 9.1. Stripe v11.18.0 PaymentIntent Status - Breaking Change Frontend

**âš ï¸ CRITIQUE** : Tous les composants qui testent `PaymentIntent.status` doivent Ãªtre mis Ã  jour :

```typescript
// âŒ AVANT Stripe v9:
if (paymentIntent.status === 'requires_source_action') {
  // 3DS flow (ancien nom)
}
if (paymentIntent.status === 'requires_source') {
  // Ã‰chec initial (ancien nom)
}

// âœ… APRÃˆS Stripe v11.18.0:
if (paymentIntent.status === 'requires_action') {
  // 3DS flow (nouveau nom)
}
if (paymentIntent.status === 'requires_payment_method') {
  // Ã‰chec initial - carte invalide, expirÃ©e, etc. (nouveau nom)
}
```

### 9.2. Composants Frontend Ã  Auditer - Status PaymentIntent

**âš ï¸ CRITIQUE** : Fichiers frontend qui gÃ¨rent les status de paiement :

```typescript
// COMPOSANTS Ã€ VÃ‰RIFIER/ADAPTER:
// - kng-payment/*.component.ts : Gestion status PaymentIntent
// - kng-subscription/*.component.ts : Affichage status abonnements
// - kng-cart-checkout.component.ts : Flow 3DS et erreurs paiement
// - kng-subscription-control.component.ts : Filtres abonnements actifs

// PATTERNS Ã€ RECHERCHER ET CORRIGER:
// - if (status === 'requires_source_action') â†’ 'requires_action'
// - if (status === 'requires_source') â†’ 'requires_payment_method'
// - switch (paymentIntent.status) â†’ vÃ©rifier tous les cas
// - status.includes('requires_source') â†’ mettre Ã  jour
// - Toute logique basÃ©e sur les anciens status Stripe v9
```

### 9.3. Subscription Control - Filtres Abonnements

**âš ï¸ CRITIQUE** : Logique d'affichage des abonnements actifs Ã  corriger :

```typescript
// kng-subscription-control.component.ts [CRITIQUE]
// ğŸ”„ AVANT: filter(contract => contract.status=='active')
// ğŸ”„ APRÃˆS: filter(contract => contract.status=='active' && latestPaymentIntent?.status=='succeeded')

// NOUVEAUX STATUS Ã€ SUPPORTER:
// - status: 'active' avec pending_setup_intent (abonnements futurs)
// - metadata.acceptUnpaid pour gestion factures impayÃ©es
// - billing_cycle_anchor pour abonnements programmÃ©s
```

### 9.4. Cart Checkout - Customer Default Payment Method

**âš ï¸ CRITIQUE** : IntÃ©gration de la stratÃ©gie Customer Default Payment Method :

```typescript
// kng-cart-checkout.component.ts [CRITIQUE]
// ğŸ”„ setPaymentMethod() : Integration customer default payment method
// ğŸ”„ checkPaymentMethod() : Support cascade automatique Stripe
// ğŸ”„ FIXME ligne 495 : 'payment.issue crashing' Ã  corriger

// NOUVELLE LOGIQUE:
// 1. customer.addMethod() configure automatiquement default_payment_method
// 2. subscription.create() utilise customer.invoice_settings.default_payment_method
// 3. Cascade automatique si default Ã©choue
// 4. Plus besoin de gÃ©rer manuellement default_payment_method sur subscription
```

### 9.5. Anti-Double Commande - Synchronisation Frontend/Backend

**âš ï¸ CRITIQUE** : Robustesse du panier aprÃ¨s commande :

```typescript
// kng-cart.component.ts [Ã€ SYNCHRONISER]
// ğŸ”„ clearAfterOrder() : Synchroniser avec backend clearAfterOrdered
// ğŸ”„ setTimeout robustesse : Anti-double commande frontend

// PROBLÃˆME IDENTIFIÃ‰:
// - setTimeout peut Ã©chouer (navigation, fermeture onglet)
// - Logique clearAfterOrdered vs clearAfterOrder incohÃ©rente
// - Besoin verrous anti-double commande cÃ´tÃ© frontend
```

### 9.6. Gestion Erreurs Paiement - Messages Utilisateur

**âš ï¸ CRITIQUE** : Messages d'erreur Ã  adapter aux nouveaux status :

```typescript
// NOUVEAUX MESSAGES Ã€ GÃ‰RER:
// - requires_payment_method: "MÃ©thode de paiement invalide"
// - incomplete subscription: "Abonnement en attente de validation"
// - pending_setup_intent: "Abonnement programmÃ© avec succÃ¨s"
// - acceptUnpaid metadata: "Factures en attente de paiement"

// COMPOSANTS AFFECTÃ‰S:
// - Error handling dans tous les composants de paiement
// - Messages de confirmation d'abonnement
// - Notifications de status de paiement
```

### 9.7. Tests Frontend - Validation Required

**âš ï¸ CRITIQUE** : Tests e2e Ã  adapter aux changements Stripe v11.18.0 :

```typescript
// TESTS Ã€ VÃ‰RIFIER/ADAPTER:
// - Flow 3DS avec nouveaux status
// - CrÃ©ation d'abonnements avec customer default payment method
// - Gestion des abonnements futurs (billing_cycle_anchor)
// - Anti-double commande aprÃ¨s validation
// - Affichage correct des status d'abonnements
```

### 9.8. Build et Compilation - VÃ©rifications

**âš ï¸ CRITIQUE** : S'assurer de la compilation avant tests :

```bash
# âœ… OBLIGATOIRE avant tout test frontend:
cd /home/evaleto/nodejs/karibou.ch/karibou-seed
ng build  # âœ… Build development (PAS npm run build = production)

# âœ… PUIS tests spÃ©cifiques:
ng test --watch=false --browsers=ChromeHeadless
ng e2e
```

### 9.9. Checklist Migration Frontend Karibou-Wallet

**âš ï¸ CRITIQUE** : Ã‰lÃ©ments Ã  ne pas oublier lors de la migration :

- [ ] **Status PaymentIntent** : Remplacer `requires_source_action` par `requires_action` et `requires_source` par `requires_payment_method`
- [ ] **Subscription Control** : Filtres abonnements avec nouveaux critÃ¨res
- [ ] **Cart Checkout** : Customer Default Payment Method strategy
- [ ] **Error Messages** : Adapter aux nouveaux status Stripe v11.18.0
- [ ] **Anti-Double** : Synchroniser clearAfterOrder frontend/backend
- [ ] **Tests e2e** : Valider tous les flows de paiement
- [ ] **Build Process** : `ng build` avant tests (pas `npm run build`)

Cette migration frontend est **CRITIQUE** pour assurer la compatibilitÃ© avec karibou-wallet v11.18.0+ ! ğŸš¨ğŸ’³
