<h2>{{i18n[locale].title_subscription}}</h2>
<div class="customer" >
  <div class="kng-boxed with-border subscription" [hidden]="contracts.length">
    <div class="label">{{i18n[locale].title_subscription}}</div>
    <div class="">
      <p>Aucun abonnement actif</p>
    </div>
    <button [routerLink]="'/store/'+store+'/home/subscription'">D√©couvrir</button>
  </div>

  <div class="kng-boxed with-border  subscription" [class.premium]="contract.plan=='patreon'" *ngFor="let contract of openContracts">
    <div class="label">
      {{getContractDescription(contract)}}
    </div>
    <div class="content">
      <div class="items">
        <ul>
          <li *ngFor="let item of contract.items"><b>{{item.quantity}}x</b> {{item.title}} ({{item.part}})</li>
        </ul>
      </div>

      <div class="bottom"> <a role="button" [routerLink]="[]" [queryParams]="getOpenParams(contract.id)" queryParamsHandling="merge">{{getContractAction(contract)}}</a></div>
    </div>
  </div>
</div>

<!-- ITEMS POPUP -->
<ng-container *ngIf="currentContract">

  <div class="blured" ></div>
  <div class="container top">
    <button (click)="onClose()" class="close">
        <span class=" material-symbols-outlined">close</span>
    </button>
    <div class="subscription-container" >
      <!-- ‚úÖ Header Section - Modernis√© -->
      <header class="subscription-header">
        <h2 class="subscription-title">{{i18n[locale].subtitle_subscription_start}} {{currentContract.start|date:'EEEE d MMM yyyy'}}</h2>
      </header>
      <div class="options-section ">
        <div class="option-card">
          <div class="option-info">
            <span class="option-label">{{i18n[locale].subtitle_subscription_next_delivery}}</span>
            <span class="option-value bold">{{currentContract.nextInvoice | date:'EEEE d MMMM yyyy'}}</span>
          </div>
          <span class="option-badge">{{getShippingTime(currentContract)}}</span>
        </div>
      </div>

      <ul *ngIf="currentContract.patreon.length; else shippingTemplate">
        <li class="contrasted" *ngFor="let item of currentContract.patreon"><b>{{item.quantity}}x</b> <span class="left">{{item.title}}</span> <b>{{(item.unit_amount/100)|number:'1.2-2'}} fr</b></li>
      </ul>

      <!-- Display Items, Shipping, Services -->
      <ng-template #shippingTemplate>
        <!-- ‚úÖ NOUVEAU : Utilisation du composant kng-subscription-item -->
        <kng-subscription-item
          [contract]="currentContract"
          [config]="config"
          [locale]="locale"
          [showTitle]="true"
          [allowSave]="currentContract.status!='canceled' && !currentContract.patreon.length && !contract_requires_action && !contract_requires_method"
          [allowAddItem]="currentContract.status!='canceled' && !currentContract.patreon.length && !contract_requires_action && !contract_requires_method"
          (updateComplete)="onSubscriptionItemUpdated($event)"
          (updateError)="onSubscriptionItemError($event)"
          (addItemClick)="onAddItemToCart()">
        </kng-subscription-item>

        <!-- ‚úÖ Section Options -->
        <section class="options-section" *ngIf="!currentContract.patreon?.length">
          <h4 class="options-title">{{i18n[locale].subtitle_subscription_options}}</h4>

          <div class="options-cards">
            <!-- Add Item Button (si actif et pas de probl√®me de paiement) -->
            <div class="add-item-action"
                *ngIf="currentContract.status !== 'canceled' && !contract_requires_action && !contract_requires_method">
              <button class="secondary" (click)="onAddItemToCart()">
                <i class="material-symbols-outlined">add_shopping_cart</i>
                {{i18n[locale].subtitle_subscription_add}}
              </button>
            </div>

            <!-- Fr√©quence Card (toujours visible) -->
            <div class="option-card">
              <div class="option-info">
                <span class="option-label">{{llabel.subtitle_subscription_status}}</span>
                <span class="option-value">{{getFrequency(currentContract)}} / {{getDayOfWeek(currentContract.dayOfWeek)}}</span>
              </div>
            </div>

            <!-- Pause Card (si actif et pas de probl√®me de paiement) -->
            <div class="option-card pause-card"
                 *ngIf="currentContract.status !== 'paused' && currentContract.status !== 'canceled' && !contract_requires_method">
              <div class="option-info">
                <span class="option-label">{{llabel.subtitle_subscription_pause}}</span>
              </div>
              <div class="pause-picker">
                <input type="date"
                       id="subdate"
                       (change)="pauseUntil = $event.target.valueAsDate"
                       [valueAsDate]="until"
                       [min]="until | date:'yyyy-MM-dd'" />
                <button class="pause-btn"
                        (click)="onPause(pauseUntil)"
                        [disabled]="pauseInDays < 7">
                  {{i18n[locale].subtitle_subscription_pause_action}} {{pauseUntil | date:'EEE d MMM'}}
                </button>
              </div>
            </div>

            <!-- Paused Status Card (si en pause) -->
            <div class="option-card paused-card" *ngIf="currentContract.status === 'paused'">
              <div class="option-info">
                <span class="option-label">{{llabel.subtitle_subscription_paused}}</span>
                <span class="option-value">{{currentContract.pauseUntil | date:'EEEE d MMMM yyyy'}}</span>
              </div>
              <span class="option-badge">‚è∏Ô∏è</span>
            </div>
          </div>

        </section>


        <!-- Footer Actions (si non annul√©) -->
        <footer class="footer-actions" *ngIf="currentContract.status !== 'canceled'">
          <button class="cancel-btn" (click)="onDelete()">
            {{llabel.subtitle_subscription_cancel}}
          </button>
        </footer>
      </ng-template>

      <div class="block-info red" *ngIf="currentContract.status=='canceled'">
        {{i18n[locale].subtitle_subscription_end}}
      </div>

      <!-- ‚úÖ Payment errors section (ul for legacy compatibility) -->
      <ul [hidden]="!hasModernPaymentError && !shouldShowLegacyError">
        <!-- ‚úÖ NOUVEAU : Interface moderne d'erreurs de paiement -->
        <ng-container *ngIf="hasModernPaymentError">

          <!-- üîê 3D Secure Authentication Required -->
          <li *ngIf="paymentError.action === 'authenticate'" [class]="errorUrgencyClass">
            <div class="title_payment orange pulse">
              {{paymentError.icon}} Confirmation de paiement requise
            </div>
            <p class="error-message">{{paymentError.message}}</p>
            <button class="authenticate-btn" (click)="onConfirmPaymentIntent()">
              Confirmer le paiement (3D Secure)
            </button>
          </li>

          <!-- üí≥ Replace Payment Method (Expired/Invalid) -->
          <li *ngIf="paymentError.action === 'replace'" [class]="errorUrgencyClass">
            <div class="title_payment red">
              {{paymentError.icon}}
              <span *ngIf="paymentError.reason === 'expired'">Votre carte a expir√©</span>
              <span *ngIf="paymentError.reason === 'invalid_method'">M√©thode de paiement invalide</span>
              <span *ngIf="paymentError.reason !== 'expired' && paymentError.reason !== 'invalid_method'">Remplacer la m√©thode de paiement</span>
            </div>
            <p class="error-message">{{paymentError.message}}</p>
            <div class="method" *ngIf="userPayment">
              M√©thode actuelle ‚Üí
              <span class="method name">{{userPayment.issuer}} **{{userPayment.last4}}</span>&nbsp;
              <span class="note">{{userPayment.expiryToDate()|date:'MM/y'}}</span>
            </div>
            <kng-user-payment [config]="config" [user]="user" (updated)="onUpdatePaymenMethod($event)"></kng-user-payment>
          </li>

          <!-- üö´ Update Payment Method (Declined) -->
          <li *ngIf="paymentError.action === 'update'" [class]="errorUrgencyClass">
            <div class="title_payment red">
              {{paymentError.icon}}
              <span *ngIf="paymentError.reason === 'declined'">Carte refus√©e</span>
              <span *ngIf="paymentError.reason !== 'declined'">Mise √† jour requise</span>
            </div>
            <p class="error-message">{{paymentError.message}}</p>
            <div class="method" *ngIf="userPayment">
              M√©thode concern√©e ‚Üí
              <span class="method name">{{userPayment.issuer}} **{{userPayment.last4}}</span>&nbsp;
              <span class="note">{{userPayment.expiryToDate()|date:'MM/y'}}</span>
            </div>
            <kng-user-payment [config]="config" [user]="user" (updated)="onUpdatePaymenMethod($event)"></kng-user-payment>
          </li>

          <!-- ‚ûï Setup Payment Method (Missing) -->
          <li *ngIf="paymentError.action === 'setup'" [class]="errorUrgencyClass">
            <div class="title_payment red">
              {{paymentError.icon}} Aucune m√©thode de paiement configur√©e
            </div>
            <p class="error-message">{{paymentError.message}}</p>
            <p *ngIf="paymentError.teamMessage" class="team-message">
              <strong>‚ÑπÔ∏è Information :</strong> {{paymentError.teamMessage}}
            </p>
            <kng-user-payment [config]="config" [user]="user" (updated)="onUpdatePaymenMethod($event)"></kng-user-payment>
          </li>

          <!-- üìû Contact Support -->
          <li *ngIf="paymentError.action === 'contact'" [class]="errorUrgencyClass">
            <div class="title_payment orange">
              {{paymentError.icon}} Contactez votre banque
            </div>
            <p class="error-message">{{paymentError.message}}</p>
            <div class="contact-info">
              <p><strong>Que faire ?</strong></p>
              <ul>
                <li>Contactez votre banque pour plus d'informations</li>
                <li>V√©rifiez les limites de votre carte</li>
                <li>Ou utilisez une autre m√©thode de paiement</li>
              </ul>
            </div>
            <kng-user-payment [config]="config" [user]="user" (updated)="onUpdatePaymenMethod($event)"></kng-user-payment>
          </li>

          <!-- üîÑ Retry Payment -->
          <li *ngIf="paymentError.action === 'retry'" [class]="errorUrgencyClass">
            <div class="title_payment orange">
              {{paymentError.icon}}
              <span *ngIf="paymentError.reason === 'canceled'">Paiement annul√©</span>
              <span *ngIf="paymentError.reason !== 'canceled'">R√©essayer le paiement</span>
            </div>
            <p class="error-message">{{paymentError.message}}</p>
            <button class="retry-btn" (click)="onConfirmPaymentIntent()">
              R√©essayer le paiement
            </button>
          </li>

        </ng-container>

        <!-- ‚úÖ FALLBACK : Interface legacy pour compatibilit√© -->
        <ng-container *ngIf="shouldShowLegacyError">

          <!---3D secure (Legacy) -->
          <li [hidden]="!contract_requires_action" >
            <div class="title_payment red">Votre abonnement n'est pas encore actif </div>
            <button class=""  (click)="onConfirmPaymentIntent()">{{i18n[locale].subtitle_subscription_confirm_method}}</button>
          </li>

          <!---new payment method (Legacy) -->
          <li [hidden]="!contract_requires_method">
            <div class="title_payment red">Activer votre abonnement avec une nouvelle m√©thode de paiement</div>
            <div class="method" *ngIf="userPayment">
              Celle-ci ne fonctionne plus ‚Üí
              <span class="method name">{{userPayment.issuer}}  **{{userPayment.last4}}</span>&nbsp;
              <span class="note">{{userPayment.expiryToDate()|date:'MM/y'}}</span>
            </div>
            <kng-user-payment [config]="config" [user]="user" (updated)="onUpdatePaymenMethod($event)"></kng-user-payment>
          </li>

        </ng-container>


        <!-- FIXME : migrate to latest styles -->
        <li class="contrasted-sm" *ngIf="!currentContract.patreon?.length">
          <div class="title">{{llabel.subtitle_subscription_status}}   </div>
          <label for="subdate" class="date kng-chip">
            <b>{{getFrequency(currentContract)}}</b> /
            <b>{{getDayOfWeek(currentContract.dayOfWeek)}} ({{getShippingTime(currentContract)}})</b>  <b class="green">‚úì</b>
          </label>
        </li>
        <li class="contrasted-sm" [hidden]="currentContract.status=='paused' || currentContract.status=='canceled' || contract_requires_method">
          <div class="title" [hidden]="currentContract.status=='paused'">
            <span >{{llabel.subtitle_subscription_pause}}&nbsp;</span>
            <span class="bold">{{pauseUntil|date:'EEE d MMM'}} ?</span>
            <input type="date" id="subdate" #subdate (change)="pauseUntil = subdate.valueAsDate"  [valueAsDate]="until" [min]="until| date:'yyyy-MM-dd'"  />

          </div>

          <button class="_date"  (click)="onPause(pauseUntil)"   [disabled]="pauseInDays<7">
            {{i18n[locale].subtitle_subscription_pause_action}} &nbsp;<b>{{pauseUntil| date:'EEE d MMM'}}</b>
          </button>
        </li>

        <li class="contrasted-sm" [hidden]="currentContract.status!='paused'">
          <div class="bold title">{{llabel.subtitle_subscription_paused}}  </div>
          <label for="subdate" class="date kng-chip">
            <b>{{currentContract.pauseUntil| date:'EEE d MMM'}} ‚úì</b>
          </label>
        </li>
        <li class="separator"><hr class="dashed"></li>
        <li [hidden]="currentContract.status=='canceled'">
          <div class="red" >{{llabel.subtitle_subscription_cancel}}</div>
          <button class="danger"  (click)="onDelete()">{{label.action_del}}</button>
        </li>
      </ul>

      <p class="block-info red" [hidden]="!error"><b>Opps:</b> {{error}}</p>

      <!-- ORDER FEEDBACK -->

      <!-- FEEDBACK ACTIONS -->

    </div>
  </div>

</ng-container>
