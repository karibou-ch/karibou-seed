<!-- NAVIGATION  -->
<div class="kng-checkout-drawer" [class.kng-drawer-open]="open">

  <!-- brand -->
  <div class="k-brand">
    <b>v{{VERSION}}-{{iOS||'n'}}</b>
  </div>

  <button class="close" (click)="open = false">
    <span class="size-large material-symbols-outlined">close</span>
  </button>

  <!-- CHECKOUT-->
  <div class="checkout" *ngIf="isReady">
    <div class="cart-container">
      <!-- PAYMENT-->
      <div class="order-address" [class.is-done]="selectPaymentIsDone" *ngIf="user.isAuthenticated()&&user.isReady() && isOpen()">
        <section hidden [innerHtml]="config?.shared.hub.checkout.payment[locale]"></section>


        <!-- FIXME hide wallet method -->
        <!--               [hidden]="payment.issuer=='wallet'"-->
        <section class="payments">
          <div class="payment checked"
            *ngIf="currentPayment?.issuer"
            (click)="selectPaymentIsDone=!selectPaymentIsDone"
            [class.error]="!currentPayment.isValid()"
            [class.on-selection]="!selectPaymentIsDone">
            <label [hidden]="!selectPaymentIsDone"> Changer </label>
            <div class="method name"><span class="highlight">{{issuer[currentPayment.issuer].label}}</span>  **{{currentPayment.last4}}</div>
          </div>

          <!-- INLINE NEW PAYMENT IN FIRST PLACE -->
          <div class="address-new" *ngIf="!userPaymentsCard.length && !selectPaymentIsDone">
            <kng-user-payment [title]="label.cart_payment_title" [config]="config" [user]="user" (updated)="onPaymentSave($event)"></kng-user-payment>
          </div>

          <!-- LIST PAYMENTS -->
          <div class="payment {{payment.issuer}}" *ngFor="let payment of userPayments"
            [class.error]="!payment.isValid()" [hidden]="selectPaymentIsDone"
            (click)="setPaymentMethod(payment)">
            <label><input type="checkbox" [checked]="currentPayment && payment.alias == currentPayment.alias"></label>
            <div class="method name">{{issuer[payment.issuer].label}}  **{{payment.last4}}</div>
            <div class="note">{{payment.expiryToDate()|date:'MM/y'}} <span class="payment">{{label.cart_payment_not_available}}</span></div>
          </div>

          <!-- MANAGE PAYMENTS -->
          <div class="profile-action" [hidden]="selectPaymentIsDone && currentPayment || !userPaymentsCard.length" [routerLink]="['./user/login-or-payment']">
            <div class="button">
              <span class="material-symbols-outlined black">add_box</span>  {{glabel.user_payment_add}}
            </div>
          </div>
        </section>

        <kng-wallet [user]="user" hidden></kng-wallet>
      </div>

      <!-- ADDRESS IFF isAuth()-->
      <div class="order-address" [class.is-done]="selectAddressIsDone" [hidden]="!user.isAuthenticated()||!user.isReady()||!isOpen()">
        <section class="address-title" [innerHtml]="config?.shared.hub.checkout.address[locale]"></section>

        <!-- USER ADDRESS -->
        <section class="addresses">
          <div class="address checked"
              (click)="selectAddressIsDone=!selectAddressIsDone"
              [class.on-selection]="!selectAddressIsDone"
              [hidden]="!currentShipping()||!currentAddress.streetAdress">
              <label [hidden]="!selectAddressIsDone">Changer</label>

              <div class="name" [class.deposit]="currentAddressIsDeposit">{{currentAddress.name}}</div>
              <div class="street text-overflow">{{currentAddress.streetAdress}} / {{currentAddress.postalCode}}</div>
              <div class="note text-overflow"><b>{{label.cart_info_note}}</b> {{currentAddress.note}}</div>
              <div class="shipping-amount">Fr  {{computeShippingByAddress(currentAddress)|number:'1.2-2'}}</div>
          </div>
          <!-- INLINE NEW ADDRESS IN FIRST PLACE -->
          <div class="address-new" *ngIf="!userAddresses.length && !selectAddressIsDone">
            <kng-address [phone]="userPhone" [title]="glabel.user_shipping_title" [config]="config" (updated)="onAddressSave($event)"></kng-address>
          </div>

          <!-- USER ADDRESS -->
          <div class="address" *ngFor="let address of userAddresses"
              (click)="setShippingAddress(address)" [hidden]="selectAddressIsDone && currentAddress.streetAdress">
              <label><input type="checkbox" [checked]="isSelectedAddress(address)"></label>
              <div class="name">{{address.name}}</div>
              <div class="street text-overflow">{{address.streetAdress}} / {{address.postalCode}}</div>
              <div class="note text-overflow"><b>{{label.cart_info_note}}</b> {{address.note}}</div>
              <div class="shipping-amount">Fr  {{computeShippingByAddress(address)|number:'1.2-2'}}</div>
          </div>
          <!-- DEPOSIT ADDRESS -->
          <div class="address deposit" *ngFor="let address of getDepositAddress()"
              [hidden]="selectAddressIsDone && currentAddress.streetAdress || !address.active || useCartSubscriptionView"
              (click)="setShippingAddress(address)">
              <label><input type="checkbox" [checked]="isSelectedAddress(address)"></label>
              <div class="name collect">{{address.name}}</div>
              <div class="street text-overflow">{{address.streetAdress}}</div>
              <div class="note text-overflow"><b>{{label.cart_info_note}}</b> {{label.cart_deposit}}</div>
              <div class="shipping-amount">Fr  {{(address.fees)|number:'1.2-2'}}</div>
          </div>

          <!-- MANAGE ADDRESSES -->
          <div class="profile-action" [hidden]="selectAddressIsDone && currentAddress.streetAdress || !userAddresses.length">
            <button [routerLink]="['./user/login-or-address']">
              <span class="material-symbols-outlined black">add_box</span> {{glabel.user_address_add}}
            </button>
          </div>

        </section>
      </div>

      <!-- SUBSCRIPTION OPTIONS -->
      <div class="subscription" [hidden]="!useCartSubscriptionView || hasPendingSubscription">
        <kng-subscription-option [checkout]="true" [quiet]="true" [contract]="hasUpdateContract" [hub]="hub" *ngIf="useCartSubscriptionView"></kng-subscription-option>
      </div>

      <div class="subscription" *ngIf="hasPendingSubscription">
          <!-- DO SUBSCRIPTION -->
          <div [hidden]="!useCartSubscriptionView">
            <button class="button" (click)="doSubscription()" >{{label.cart_update_subscription_payment}}</button>
          </div>

          <div class="bill error" [hidden]="!errorMessage">
            {{errorMessage}}
          </div>
      </div>

      <div class="order-address">
        <!-- Info sur le montant (exclusif panier) -->
        <div class="block-info info-amount">
          <div class="info">ðŸ“Œ
            {{ label.cart_amount_1 }}
            {{ label.cart_amount_2 }}
          </div>
        </div>

        <!-- INFO HELP MOBILE -->
        <div class="bill help">
          <a class="phone" href="tel:{{hub.address.phone}}"><i class="material-symbols-outlined icon">phone</i>&nbsp;{{label.cart_info_help}} {{hub.address.phone}}</a>
        </div>

      </div>
    </div>
    <div class="cart-container">
      <!-- RESUME -->
      <!-- RESUME subscription or simple order -->
      <div class="order-resume" *ngIf="isOpen && !hasPendingSubscription">
        <kng-cart-invoice
          [type]="useCartSubscriptionView ? 'subscription' : 'cart'"
          [user]="user"
          [data]="{
            items: items,
            address: currentAddress,
            payment: currentPayment,
            contract: contract,
            updateItems: updateItems,
            subscriptionParams: subscriptionParams
          }"
          [config]="config"
          [hub]="hub"
          [i18n]="i18n">
        </kng-cart-invoice>

        <!-- BLOCK DE RIGHT -->
        <div class="order-resume-block border-left">


          <!-- INFO SHIPPING NOTE -->
          <div class="bill" [hidden]="isCartDeposit()">
            <div class="small">{{glabel.user_address_note}}</div>
            <div class="input-text">
              <input type="text" class="highlight" placeholder="code, note, etc" [(ngModel)]="shippingNote" />
            </div>
          </div>



          <div class="bill bill-title">
            <!-- DO ACCEPT-CG-->
            <div class="slot">
              <div >
                <input type="checkbox" [(ngModel)]="cgAccepted" >
              </div>
              <div class="info">
                <a href="javascript:;" class="link"
                  [routerLink]="['/store',store,'content','conditions-generales-de-vente']">{{label.cart_cg}}</a>

                <span class="dotted">{{label.cart_cg_middle}}</span>

                <a href="javascript:;" class="link"
                  [routerLink]="['/store',store,'content','conditions-generales-de-vente']">{{label.cart_cg_18}}</a>
              </div>

            </div>
            <!-- DO ORDER-->
            <div [hidden]="useCartSubscriptionView" >
              <button class="default" [disabled]="isFinalizeDisabled"  (click)="doOrderRouting()" >
                <div>
                  <b>{{label.cart_order}}</b>
                  <span class="material-symbols-outlined icon" [hidden]="!isRunning" [class.waiting]="isRunning"> clock_loader_10</span>

                </div>


              </button>
            </div>
            <!-- DO SUBSCRIPTION -->
            <div [hidden]="!useCartSubscriptionView">
              <button class="default" [disabled]="isFinalizeDisabled"  (click)="doSubscription()" >
                <div>
                {{label.cart_subscription}}
                <span class="material-symbols-outlined icon" [hidden]="!isRunning" [class.waiting]="isRunning"> clock_loader_10</span>
                </div>
              </button>

            </div>

            <div class="bill error" [hidden]="!errorMessage">
              {{errorMessage}}
            </div>
          </div>
        </div>

        <!-- CHECKOUT  MSG -->
        <div class="checkout-msg" *ngIf="config.shared.hub.checkout.active">
          <div [innerHtml]="config.shared.hub.checkout.message[locale]"></div>
        </div>

      </div>

    </div>
  </div>
</div>
